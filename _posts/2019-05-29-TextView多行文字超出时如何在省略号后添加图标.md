---
layout:     post
title:      TextView多行文字超出时如何在省略号后添加图标
subtitle:   TextView的图文混排知识
date:       2019-05-29
author:     Tristan
header-img: img/post-bg-textview.png
catalog: true
tags:
    - TextView
    - 图文混排
    - Android
    
---

## 背景
最近在做feed流模板样式调整时，出现了这样一个需求，要求在标题**文字后面**（不是控件后面）加一个图片标签来展示精帖。标题文字控制最大显示两行，文字超出部分用省略号代替，图标紧跟在文字或是省略号后显示。
<div style="text-align: center;"><img src="../../../../img/post-textview-1.png" width="80%" style="display: inline-block; border: 2px solid #000000; margin: 0; padding: 0;"/></div>

## 技术点
#### 图文混排
Android官方对TextView的图文混排提供了支持，我们可以从以下三种方案实现TextView的图文混排：
> 1. 在TextView中使用Compound Drawable属性；<br/>
> 2. 在TextView中显示HTML文本；<br/>
> 3. 在TextView中使用Spannable多样式显示。<br/>

`方案1`实现效果其实跟在控件后面（周围）加图片标签的性质是一样的，它无法满足图标紧跟文字显示的需求。

`方案2`是通过将HTML内容转化为Spanned格式在TextView中进行显示，它的输出是SpannableStringBuilder，实现原理跟方案3一样。又因它有特定的应用场景，此处不做过多描述，列出核心源码就能理解。
```java
public Spanned convert() {

    mReader.setContentHandler(this);
    try {
        mReader.parse(new InputSource(new StringReader(mSource)));
    } catch (IOException e) {
        // We are reading from a string. There should not be IO problems.
        throw new RuntimeException(e);
    } catch (SAXException e) {
        // TagSoup doesn't throw parse exceptions.
        throw new RuntimeException(e);
    }

    // Fix flags and range for paragraph-type markup.
    Object[] obj = mSpannableStringBuilder.getSpans(0, mSpannableStringBuilder.length(), ParagraphStyle.class);
    for (int i = 0; i < obj.length; i++) {
        int start = mSpannableStringBuilder.getSpanStart(obj[i]);
        int end = mSpannableStringBuilder.getSpanEnd(obj[i]);

        // If the last line of the range is blank, back off by one.
        if (end - 2 >= 0) {
            if (mSpannableStringBuilder.charAt(end - 1) == '\n' &&
                mSpannableStringBuilder.charAt(end - 2) == '\n') {
                end--;
            }
        }

        if (end == start) {
            mSpannableStringBuilder.removeSpan(obj[i]);
        } else {
            mSpannableStringBuilder.setSpan(obj[i], start, end, Spannable.SPAN_PARAGRAPH);
        }
    }

    return mSpannableStringBuilder;
}
```

`方案3`的输出格式是SpannableString，它和`方案2`的SpannableStringBuilder都实现了CharSequence接口，TextView的setText()方法传入参数其实就是这个接口类型；同时它们又都实现了Spannable接口，Spannable的setSpan()方法定义了如何编辑字符串，通过它可以设置一些格式对象（例如字体大小、下划线、替换为图片、点击事件等），这样就实现富文本显示了。
<div style="text-align: center;"><img src="../../../../img/post-textview-2.png" width="100%" style="display: inline-block; border: 2px solid #000000; margin: 0; padding: 0;"/></div>

#### SpannableString
图片替换指定文本实现图文混排。
```java
String text = guessLikeBean.getTitle()+"(精)";
SpannableString imageString = new SpannableString(text);
Drawable image = mContext.getResources().getDrawable(R.drawable.ic_recommend_job_jing2);
ImageSpan imageSpan = new ImageSpan(image);
imageString.setSpan(imageSpan, imageString.length()-3, imageString.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);
mTvTitle.setText(imageString);
```

#### TextView的Layout属性
Layout
```java
/**
 * Return the offset of the first character to be ellipsized away,
 * relative to the start of the line.  (So 0 if the beginning of the
 * line is ellipsized, not getLineStart().)
 */
public abstract int getEllipsisStart(int line);

/**
 * Returns the number of characters to be ellipsized away, or 0 if
 * no ellipsis is to take place.
 */
public abstract int getEllipsisCount(int line);
```


#### Drawble属性
<div style="text-align: center;"><img src="../../../../img/post-textview-3.png" width="20%" style="display: inline-block; border: 2px solid #000000; margin: 0; padding: 0;"/></div>

## 文献
[Android图文混排实现方式详解](https://juejin.im/post/59a75a50518825241e22394d#heading-7)<br/>
[Android TextView富文本深入探索](https://www.jianshu.com/p/aa53ee98d954)
