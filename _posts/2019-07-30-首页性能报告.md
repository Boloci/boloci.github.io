---
layout:     post
title:      首页性能报告
subtitle:   APP性能优化应该关注哪些点
date:       2019-07-30
author:     Tristan
header-img: img/post-bg-homepage-performance.jpg
catalog: true
tags:
    - 首页
    - 性能
    - Android
    
---

## 工具
#### 通过["严格模式"](https://www.jianshu.com/p/271474cd1d91)排查主线程中是否有io操作
问题一，切换到后台toast提示加载字体出现主线程io耗时操作。
```
2019-07-30 16:29:16.832 22351-22351/? D/StrictMode: StrictMode policy violation; ~duration=75 ms: android.os.strictmode.DiskReadViolation
        at android.os.StrictMode$AndroidBlockGuardPolicy.onReadFromDisk(StrictMode.java:1504)
        at java.io.UnixFileSystem.checkAccess(UnixFileSystem.java:251)
        at java.io.File.exists(File.java:815)
        at android.graphics.Typeface.isAndroidFont(Typeface.java:215)
        at android.widget.Toast.change2VivoFont(Toast.java:399)
        at android.widget.Toast.makeText(Toast.java:313)
        at android.widget.Toast.makeText(Toast.java:290)
        at com.wuba.commons.toast.ToastCompat.makeText(ToastCompat.java:51)
        at com.wuba.commons.utils.WubaToast.makeText(WubaToast.java:21)
        at com.wuba.commons.utils.ToastUtils.show(ToastUtils.java:50)
        at com.wuba.commons.utils.ToastUtils.showToast(ToastUtils.java:46)
        at com.wuba.application.GroundMonitor.onBackground(GroundMonitor.java:33)
        at com.wuba.application.GroundDetectLifecycle.onActivityStopped(GroundDetectLifecycle.java:50)
        at android.app.Application.dispatchActivityStopped(Application.java:276)
        at android.app.Activity.onStop(Activity.java:1930)
        at android.support.v4.app.FragmentActivity.onStop(FragmentActivity.java:636)
        at android.support.v7.app.AppCompatActivity.onStop(AppCompatActivity.java:184)
        at com.wuba.activity.BaseAppCompatActivity.onStop(BaseAppCompatActivity.java:79)
        at com.wuba.home.activity.HomeActivity.onStop(HomeActivity.java:881)
        at android.app.Instrumentation.callActivityOnStop(Instrumentation.java:1436)
        at android.app.Activity.performStop(Activity.java:7478)
        at android.app.ActivityThread.callActivityOnStop(ActivityThread.java:4443)
        at android.app.ActivityThread.performStopActivityInner(ActivityThread.java:4421)
        at android.app.ActivityThread.handleStopActivity(ActivityThread.java:4496)
        at android.app.servertransaction.StopActivityItem.execute(StopActivityItem.java:41)
        at android.app.servertransaction.TransactionExecutor.executeLifecycleState(TransactionExecutor.java:145)
        at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:70)
        at android.app.ActivityThread$H.handleMessage(ActivityThread.java:2051)
        at android.os.Handler.dispatchMessage(Handler.java:106)
        at android.os.Looper.loop(Looper.java:224)
        at android.app.ActivityThread.main(ActivityThread.java:7104)
        at java.lang.reflect.Method.invoke(Native Method)
        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:493)
        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:878)
```
```
public class GroundMonitor implements GroundDetectLifecycle.GroundDetectListener {
    @Override
    public void onBackground() {
        ToastUtils.showToast(mContext, "已进入后台运行");
        ...
    }
}
```
问题二，在主线程读取缓存的背景图片文件。
```
2019-07-30 17:18:41.383 2348-2348/com.wuba D/StrictMode: StrictMode policy violation; ~duration=37 ms: android.os.strictmode.DiskReadViolation
        at android.os.StrictMode$AndroidBlockGuardPolicy.onReadFromDisk(StrictMode.java:1504)
        at java.io.UnixFileSystem.checkAccess(UnixFileSystem.java:251)
        at java.io.File.exists(File.java:815)
        at com.wuba.commons.picture.ImageLoaderUtils.exists(ImageLoaderUtils.java:381)
        at com.wuba.homepage.HomePageMVPPresenter.loadBackgroundImage(HomePageMVPPresenter.java:99)
        at com.wuba.homepage.HomePageMVPFragment.onResume(HomePageMVPFragment.java:253)
        at android.support.v4.app.Fragment.performResume(Fragment.java:2498)
        at android.support.v4.app.FragmentManagerImpl.moveToState(FragmentManager.java:1501)
        at android.support.v4.app.FragmentManagerImpl.moveFragmentToExpectedState(FragmentManager.java:1784)
        at android.support.v4.app.FragmentManagerImpl.moveToState(FragmentManager.java:1852)
        at android.support.v4.app.FragmentManagerImpl.dispatchStateChange(FragmentManager.java:3269)
        at android.support.v4.app.FragmentManagerImpl.dispatchResume(FragmentManager.java:3241)
        at android.support.v4.app.FragmentController.dispatchResume(FragmentController.java:223)
        at android.support.v4.app.FragmentActivity.onResumeFragments(FragmentActivity.java:538)
        at android.support.v4.app.FragmentActivity.onPostResume(FragmentActivity.java:527)
        at android.support.v7.app.AppCompatActivity.onPostResume(AppCompatActivity.java:172)
        at android.app.Activity.performResume(Activity.java:7428)
        at android.app.ActivityThread.performResumeActivity(ActivityThread.java:4052)
        at android.app.ActivityThread.handleResumeActivity(ActivityThread.java:4092)
        at android.app.servertransaction.ResumeActivityItem.execute(ResumeActivityItem.java:51)
        at android.app.servertransaction.TransactionExecutor.executeLifecycleState(TransactionExecutor.java:145)
        at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:70)
        at android.app.ActivityThread$H.handleMessage(ActivityThread.java:2051)
        at android.os.Handler.dispatchMessage(Handler.java:106)
        at android.os.Looper.loop(Looper.java:224)
        at android.app.ActivityThread.main(ActivityThread.java:7104)
        at java.lang.reflect.Method.invoke(Native Method)
        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:493)
        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:878)
```
```
@Override
public void loadBackgroundImage() {
    String homeBgUrl = WubaPersistentUtils.getHomeCityBuildingUrl(mContext);
    Uri homeBgUri = Uri.parse(homeBgUrl);
    if (ImageLoaderUtils.getInstance().exists(homeBgUri)) {
        String realPath = ImageLoaderUtils.getInstance().getRealPath(homeBgUri);
        Bitmap bitmap = PicUtils.makeNormalBitmap(realPath, -1, -1, Bitmap.Config.ARGB_8888, false);
        mIView.setBackgroundImage(bitmap);
    }
}
```

#### 启动时间
| LaunchActivity | HomeActivity | Total |
| --- | --- | --- |
| 2s, 696ms | 1s, 431ms | 7s, 890ms |
| 2s, 718ms | 1s, 410ms | 7s, 832ms |
| 2s, 711ms | 1s, 398ms | 7s, 820ms |
