---
layout:     post
title:      用Flutter实现一个复杂页面
subtitle:   Flutter从入门到放弃
date:       2019-04-22
author:     Tristan
header-img: img/post-bg-flutter.png
catalog: true
tags:
    - Flutter
    - 首页
    
---

## 背景
Flutter作为全新跨平台应用框架，在页面渲染和MD开发上优势明显，可谓是业界一枝独秀。正好最近有这样的一个机会学习Flutter开发，我们便尝试用它开发一个MD风格的复杂页面，来比较跟原生应用开发的优势。也是想通过对新框架的学习探索，找到适合自身应用的框架。

## 页面展示
首页是整个应用里边交互最为复杂的一个页面了，它集合了各种滑动方式，包括：`纵向滑动、横向滑动、嵌套滑动`；同时，也集合了各种动效，包括：`下拉刷新、上拉加载、头图视差、二级吸顶、回到顶部、横向Banner和纵向News轮播`等。
<div style="color: #f00;"><img src="../../../../img/post-flutter-1.jpeg" width="33%" style="display: inline-block; border: 2px solid #000000; margin: 0; padding: 0;"/><img src="../../../../img/post-flutter-2.jpeg" width="33%" style="display: inline-block; border: 2px solid #000000; margin: 0; padding: 0; margin-left: 0.5%; margin-right: 0.5%;"/><img src="../../../../img/post-flutter-3.jpeg" width="33%" style="display: inline-block; border: 2px solid #000000; margin: 0; padding: 0;"></div>

## 开发历程
- 搭建了开发环境，新建flutter module并学习dart语法
- 调研用Flutter实现`CoordinatorLayout`的方案
- 实现了首页`主框架`的demo搭建，目前同样遇到了滑动冲突的问题，在调研解决方案
- 解决了`滑动冲突`的问题，并集成了下拉刷新能力
- 完成了各区块和feed流的`静态UI`内容，目前剩余feed流加载更多和负二楼动效
- 实现首页feed流的`加载更多`功能

## 技术难点
#### 两级吸顶
在Flutter中两级吸顶是比较容易实现的：第一级，可以用SliverAppBar，不仅可以吸顶，还带有折叠属性，折叠属性能更好的满足头部滑动时的动效处理；第二级，可以使用SliverPersistentHeader，通过pinned属性灵活选择当前模块吸顶或是不吸顶，这样就完美实现了二级feed流tab的吸顶效果。

> 而native端实现这个二级吸顶却很费力，通常你可能需要事先隐藏一个跟吸顶内容一样的驻顶view在那里，然后在页面滚动时计算吸顶内容是否已经划至顶部，维护驻顶view的可见属性达到吸顶效果。
    
```js
SliverAppBar(
  pinned: true,
  ...,
  bottom: PreferredSize(...),
),
SliverPersistentHeader(
  delegate: _SliverColumnDelegate(
    Column(...),
  )
),
SliverPersistentHeader(
  pinned: true,
  delegate: _SliverTabBarDelegate(
    TabBar(...)
  ),
),
``` 

上面粗犷的两级吸顶完成了，但想要充分满足首页的折叠效果和准确的二级吸顶需求，还得深挖一下AppBar内部的折叠计算方法。

#### SliverAppBar折叠原理
SliverAppBar是随内容一起滑动的通常作页面头部使用的一个控件，它的构造方法中有四个Widget类型的参数。
> * leading //左侧按钮
> * title //标题
> * flexibleSpace //可以展开区域
> * bottom //底部内容区域

回顾一下首页的折叠展示效果，首先排除了leading，然后title受leading占位影响宽度有限制也无法满足需要；之后，就剩下的两个参数从命名上看，flexibleSpace好像更符合折叠效果的实现思路，然后一直在尝试使用flexibleSpace实现头部折叠的需求，但开发过程中发现折叠后的高度无法达到预期。显然，使用排除法已经不好解决该问题了。想了解flexibleSpace为什么会有高度限制，必然得看下SliverAppBar的源码了。

```js
class _SliverAppBarState extends State<SliverAppBar> with TickerProviderStateMixin {
  ...
  @override
  Widget build(BuildContext context) {
    assert(!widget.primary || debugCheckHasMediaQuery(context));
    final double topPadding = widget.primary ? MediaQuery.of(context).padding.top : 0.0;
    final double collapsedHeight = (widget.pinned && widget.floating && widget.bottom != null)
      ? widget.bottom.preferredSize.height + topPadding : null;

    return MediaQuery.removePadding(
      context: context,
      removeBottom: true,
      child: SliverPersistentHeader(
        floating: widget.floating,
        pinned: widget.pinned,
        delegate: _SliverAppBarDelegate(
          ...
          collapsedHeight: collapsedHeight,
          topPadding: topPadding,
        ),
      ),
    );
  }
}

```

    final double collapsedHeight = (widget.pinned && widget.floating && widget.bottom != null)
      ? widget.bottom.preferredSize.height + topPadding : null;

变量collapsedHeight代表了折叠后头部的高度，从它的计算表达式里看出：当widget.bottom == null的时候，collapsedHeight的值为null。这就决定了头部折叠想要满足自定义的高度，不使用bottom属性是没法满足的。

#### 头图动画

    

#### 模块自己管理

    

#### 滑动冲突

    

#### 加载更多

    

## 参考文档
